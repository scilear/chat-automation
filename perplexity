#!/usr/bin/env python3
"""
Perplexity CLI - Command-line interface for Perplexity

Usage:
    perplexity login                              # Login and save session
    perplexity chat "Your message"               # Send a message
    perplexity chat --file code.py               # Send a file
    perplexity list                              # List saved conversations
    perplexity continue <session_id>             # Continue a conversation
"""

import argparse
import asyncio
import sys
import os
from pathlib import Path

sys.path.insert(0, '/home/fabien/clawd')
from chat_automation.perplexity import PerplexityAutomation
from chat_automation.config import ChatAutomationConfig

SAVE_DIR = Path.home() / ".chat_automation" / "perplexity_conversations"
SAVE_DIR.mkdir(parents=True, exist_ok=True)


class PerplexityManager:
    """Manages persistent Perplexity browser sessions - mirrors ChatManager pattern"""
    
    def __init__(self, config: ChatAutomationConfig = None, save_dir: str = "~/.chat_automation/perplexity_conversations"):
        self.config = config or ChatAutomationConfig.brave_automation()
        self.save_dir = os.path.expanduser(save_dir)
        os.makedirs(self.save_dir, exist_ok=True)
        
        self._perplexity: PerplexityAutomation = None
        self._browser_started = False
        self._current_conversation = None
    
    async def _ensure_browser(self) -> PerplexityAutomation:
        """Start browser if not running"""
        if self._perplexity is None or not await self._is_browser_alive():
            print("Connecting to browser...")
            self._perplexity = PerplexityAutomation(self.config)
            await self._perplexity.start()
            await self._perplexity.goto(self.config.perplexity_url)
            await asyncio.sleep(3)
            self._browser_started = True
            print("Browser ready")
        return self._perplexity
    
    async def _is_browser_alive(self) -> bool:
        if self._perplexity is None or self._perplexity.page is None:
            return False
        try:
            await self._perplexity.page.evaluate("1 + 1")
            return True
        except:
            return False
    
    def start_conversation(self, title: str = None) -> str:
        from datetime import datetime
        conv_id = f"perp_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        self._current_conversation = {
            'id': conv_id,
            'title': title or f"Perplexity {conv_id}",
            'messages': [],
            'created_at': datetime.now().isoformat(),
            'updated_at': datetime.now().isoformat(),
            'url': None
        }
        return conv_id
    
    async def send(self, message: str, wait_for_response: bool = True) -> str:
        import json
        from datetime import datetime
        
        if self._current_conversation is None:
            self.start_conversation()
        
        await self._ensure_browser()
        
        self._current_conversation['messages'].append({
            'role': 'user',
            'content': message,
            'timestamp': datetime.now().isoformat()
        })
        
        try:
            response = await self._perplexity.chat(message, wait_for_response=wait_for_response)
            
            self._current_conversation['messages'].append({
                'role': 'assistant',
                'content': response,
                'timestamp': datetime.now().isoformat()
            })
            self._current_conversation['updated_at'] = datetime.now().isoformat()
            
            try:
                current_url = self._perplexity.page.url
                if current_url and 'perplexity.ai' in current_url:
                    self._current_conversation['url'] = current_url
            except:
                pass
            
            await self._auto_save()
            return response
            
        except Exception as e:
            print(f"Error: {e}")
            return f"Error: {str(e)}"
    
    async def send_file(self, filepath: str, message: str = "") -> str:
        from datetime import datetime
        
        if self._current_conversation is None:
            self.start_conversation()
        
        await self._ensure_browser()
        
        self._current_conversation['messages'].append({
            'role': 'user',
            'content': f"[File: {filepath}] {message}".strip(),
            'timestamp': datetime.now().isoformat()
        })
        
        try:
            success = await self._perplexity.attach_file(filepath, message)
            if not success:
                with open(filepath, 'r') as f:
                    content = f.read()
                if len(content) > 5000:
                    content = content[:5000] + "\n\n[...truncated...]"
                response = await self._perplexity.chat(f"Please analyze this:\n\n```\n{content}\n```", wait_for_response=True)
            else:
                await self._perplexity.wait_for_response()
                response = await self._perplexity.get_last_response()
            
            self._current_conversation['messages'].append({
                'role': 'assistant',
                'content': response,
                'timestamp': datetime.now().isoformat()
            })
            self._current_conversation['updated_at'] = datetime.now().isoformat()
            
            await self._auto_save()
            return response
            
        except Exception as e:
            print(f"Error: {e}")
            return f"Error: {str(e)}"
    
    async def _auto_save(self):
        import json
        if self._current_conversation:
            filepath = os.path.join(self.save_dir, f"{self._current_conversation['id']}.json")
            with open(filepath, 'w') as f:
                json.dump(self._current_conversation, f, indent=2)
    
    async def load_conversation(self, filepath: str) -> bool:
        import json
        try:
            with open(filepath, 'r') as f:
                self._current_conversation = json.load(f)
            
            if self._current_conversation.get('url'):
                perplexity = await self._ensure_browser()
                await perplexity.goto(self._current_conversation['url'])
                await asyncio.sleep(3)
            
            return True
        except Exception as e:
            print(f"Error loading: {e}")
            return False
    
    async def close(self, keep_browser_open: bool = True):
        if self._perplexity:
            try:
                if keep_browser_open:
                    await self._perplexity.stop()
                    print("Disconnected (browser still running)")
                else:
                    await self._perplexity.close_browser()
                    print("Browser closed")
            except Exception as e:
                print(f"Note: {e}")
        self._perplexity = None


class PerplexityCLI:
    def __init__(self):
        self.chat = None
    
    async def login(self):
        print("=" * 70)
        print("PERPLEXITY LOGIN")
        print("=" * 70)
        print("\n1. Connecting to browser...")
        print("2. Navigate to https://www.perplexity.ai")
        print("3. Log in manually")
        print("4. Press Enter here when done\n")
        
        self.chat = PerplexityManager()
        
        try:
            await self.chat._ensure_browser()
            
            print("Browser is open. Please log in now.")
            print("\nPress Enter when you're logged in...")
            input()
            
            print("\n✓ Login successful!")
            print(f"✓ Session saved to: ~/.config/BraveSoftware/Brave-Automation/")
            
        except Exception as e:
            print(f"\n✗ Error: {e}")
        finally:
            if self.chat:
                await self.chat.close()
    
    async def chat_message(self, message: str, session_id: str = None):
        import json
        
        print(f"{'='*70}")
        print("PERPLEXITY")
        print(f"{'='*70}\n")
        
        self.chat = PerplexityManager()
        
        try:
            if session_id:
                conv_file = SAVE_DIR / f"{session_id}.json"
                if conv_file.exists():
                    await self.chat.load_conversation(str(conv_file))
                else:
                    print(f"Session not found: {session_id}")
                    self.chat.start_conversation()
            else:
                self.chat.start_conversation()
            
            print(f"You: {message}\n")
            print("Waiting for response...")
            
            response = await self.chat.send(message)
            
            print(f"Perplexity: {response}\n")
            
            if self.chat._current_conversation.get('url'):
                print(f"URL: {self.chat._current_conversation['url']}")
                print(f"Session ID: {self.chat._current_conversation['id']}")
                print(f"\nContinue with:")
                print(f"  ./perplexity continue {self.chat._current_conversation['id']} \"your next message\"")
            
        except Exception as e:
            print(f"\n✗ Error: {e}")
            import traceback
            traceback.print_exc()
        finally:
            if self.chat:
                await self.chat.close()
    
    async def chat_file(self, filepath: str, message: str = "", session_id: str = None):
        if not os.path.exists(filepath):
            print(f"Error: File not found: {filepath}")
            return
        
        print(f"{'='*70}")
        print("PERPLEXITY - FILE UPLOAD")
        print(f"{'='*70}\n")
        
        self.chat = PerplexityManager()
        
        try:
            if session_id:
                conv_file = SAVE_DIR / f"{session_id}.json"
                if conv_file.exists():
                    await self.chat.load_conversation(str(conv_file))
            else:
                self.chat.start_conversation()
            
            print(f"Uploading: {filepath}")
            if message:
                print(f"Message: {message}\n")
            
            response = await self.chat.send_file(filepath, message)
            
            print(f"\nPerplexity: {response}\n")
            
            print(f"Session: {self.chat._current_conversation['id']}")
            
        except Exception as e:
            print(f"\n✗ Error: {e}")
        finally:
            if self.chat:
                await self.chat.close()
    
    async def list_conversations(self):
        import json
        
        print(f"{'='*70}")
        print("SAVED PERPLEXITY CONVERSATIONS")
        print(f"{'='*70}\n")
        
        conversations = []
        for f in SAVE_DIR.glob("*.json"):
            try:
                with open(f) as file:
                    data = json.load(file)
                conversations.append({
                    'id': data.get('id', 'Unknown'),
                    'title': data.get('title', 'Untitled'),
                    'updated': data.get('updated_at', 'Unknown')[:10],
                    'messages': len(data.get('messages', [])),
                    'file': f.name
                })
            except:
                pass
        
        if not conversations:
            print("No saved conversations found.")
            return
        
        conversations.sort(key=lambda x: x['updated'], reverse=True)
        
        for i, c in enumerate(conversations[:10], 1):
            print(f"{i}. {c['title']}")
            print(f"   ID: {c['id']}")
            print(f"   Messages: {c['messages']}")
            print(f"   Updated: {c['updated']}")
            print()
        
        if len(conversations) > 10:
            print(f"... and {len(conversations) - 10} more")


def main():
    parser = argparse.ArgumentParser(
        description='Perplexity CLI - Command line interface for Perplexity',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  perplexity login                              # Login to Perplexity
  perplexity chat "Explain Python decorators"   # Send a message
  perplexity chat --file script.py              # Upload a file
  perplexity list                               # List conversations
  perplexity continue perp_2024_02_10           # Continue a conversation
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Command to run')
    
    login_parser = subparsers.add_parser('login', help='Login to Perplexity')
    
    chat_parser = subparsers.add_parser('chat', help='Send a message')
    chat_parser.add_argument('message', nargs='?', help='Message to send')
    chat_parser.add_argument('--file', '-f', help='File to upload')
    chat_parser.add_argument('--session', '-s', help='Session ID to continue')
    
    list_parser = subparsers.add_parser('list', help='List saved conversations')
    
    continue_parser = subparsers.add_parser('continue', help='Continue a conversation')
    continue_parser.add_argument('session_id', help='Session ID to continue')
    continue_parser.add_argument('message', nargs='?', help='Message to send')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    cli = PerplexityCLI()
    
    if args.command == 'login':
        asyncio.run(cli.login())
    elif args.command == 'chat':
        if args.file:
            asyncio.run(cli.chat_file(args.file, args.message or "", args.session))
        elif args.message:
            asyncio.run(cli.chat_message(args.message, args.session))
        else:
            print("Error: Provide a message or use --file")
    elif args.command == 'list':
        asyncio.run(cli.list_conversations())
    elif args.command == 'continue':
        if args.message:
            asyncio.run(cli.chat_message(args.message, args.session_id))
        else:
            print("Error: Provide a message to continue")


if __name__ == '__main__':
    main()
