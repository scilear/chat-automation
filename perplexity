#!/home/fabien/clawd/chat_automation/.venv/bin/python3
"""
Perplexity CLI - Command-line interface for Perplexity
"""

import os
os.environ["NODE_NO_WARNINGS"] = "1"

import argparse
import asyncio
import sys
from pathlib import Path
from typing import List

sys.path.insert(0, '/home/fabien/clawd')
from chat_automation.perplexity import PerplexityAutomation
from chat_automation.perplexity_conversations import PerplexityConversations, PerplexityConversation, PerplexitySpace
from chat_automation.config import ChatAutomationConfig
from chat_automation.verbose import log, set_verbose
from chat_automation.cli_common import (
    Spinner, VoiceRecorder, parse_persona,
    load_persona, list_personas as list_personas_func
)

from rich.console import Console
from rich.markdown import Markdown
from prompt_toolkit import PromptSession
from prompt_toolkit.history import FileHistory

console = Console()

SAVE_DIR = Path.home() / ".chat_automation" / "perplexity_conversations"
SAVE_DIR.mkdir(parents=True, exist_ok=True)

PERSONAS_DIR = Path(__file__).parent / "personas"

HISTORY_FILE = Path.home() / ".chat_automation" / "perplexity_history"


class PerplexityManager:
    """Manages persistent Perplexity browser sessions - mirrors ChatManager pattern"""

    def __init__(self, config: ChatAutomationConfig = None, save_dir: str = "~/.chat_automation/perplexity_conversations"):
        self.config = config or ChatAutomationConfig.brave_automation()
        self.save_dir = os.path.expanduser(save_dir)
        os.makedirs(self.save_dir, exist_ok=True)

        self._perplexity: PerplexityAutomation = None
        self._browser_started = False
        self._current_conversation = None

    async def _ensure_browser(self) -> PerplexityAutomation:
        """Start browser if not running"""
        if self._perplexity is None or not await self._is_browser_alive():
            log("Connecting to browser...")
            self._perplexity = PerplexityAutomation(self.config)
            await self._perplexity.start()
            await self._perplexity.goto(self.config.perplexity_url)
            await asyncio.sleep(3)
            self._browser_started = True
            log("Connected")
        return self._perplexity

    async def _is_browser_alive(self) -> bool:
        if self._perplexity is None or self._perplexity.page is None:
            return False
        try:
            await self._perplexity.page.evaluate("1 + 1")
            return True
        except:
            return False

    def start_conversation(self, title: str = None) -> str:
        from datetime import datetime
        conv_id = f"perp_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        self._current_conversation = {
            'id': conv_id,
            'title': title or f"Perplexity {conv_id}",
            'messages': [],
            'created_at': datetime.now().isoformat(),
            'updated_at': datetime.now().isoformat(),
            'url': None
        }
        return conv_id

    async def send(self, message: str, wait_for_response: bool = True) -> str:
        import json
        from datetime import datetime

        if self._current_conversation is None:
            self.start_conversation()

        await self._ensure_browser()

        self._current_conversation['messages'].append({
            'role': 'user',
            'content': message,
            'timestamp': datetime.now().isoformat()
        })

        try:
            response = await self._perplexity.chat(message, wait_for_response=wait_for_response)

            self._current_conversation['messages'].append({
                'role': 'assistant',
                'content': response,
                'timestamp': datetime.now().isoformat()
            })
            self._current_conversation['updated_at'] = datetime.now().isoformat()

            try:
                current_url = self._perplexity.page.url
                if current_url and 'perplexity.ai' in current_url:
                    self._current_conversation['url'] = current_url
            except:
                pass

            await self._auto_save()
            return response

        except Exception as e:
            log(f"Error: {e}")
            return f"Error: {str(e)}"

    async def send_formatted(self, message: str) -> str:
        """Send a message and return response with markdown formatting preserved"""
        from datetime import datetime

        if self._current_conversation is None:
            self.start_conversation()

        await self._ensure_browser()

        self._current_conversation['messages'].append({
            'role': 'user',
            'content': message,
            'timestamp': datetime.now().isoformat()
        })

        try:
            success = await self._perplexity.send_message(message)
            if not success:
                return "Failed to send message"

            log("Waiting for response...")
            ready = await self._perplexity.wait_for_response()
            if not ready:
                return "Response timed out"

            await asyncio.sleep(1)

            response = await self._perplexity.get_formatted_response()

            self._current_conversation['messages'].append({
                'role': 'assistant',
                'content': response,
                'timestamp': datetime.now().isoformat()
            })
            self._current_conversation['updated_at'] = datetime.now().isoformat()

            try:
                current_url = self._perplexity.page.url
                if current_url and 'perplexity.ai' in current_url:
                    self._current_conversation['url'] = current_url
            except:
                pass

            await self._auto_save()
            return response

        except Exception as e:
            log(f"Error: {e}")
            return f"Error: {str(e)}"

    async def send_file(self, filepath: str, message: str = "") -> str:
        from datetime import datetime

        if self._current_conversation is None:
            self.start_conversation()

        await self._ensure_browser()

        self._current_conversation['messages'].append({
            'role': 'user',
            'content': f"[File: {filepath}] {message}".strip(),
            'timestamp': datetime.now().isoformat()
        })

        try:
            success = await self._perplexity.attach_file(filepath, message)
            if not success:
                with open(filepath, 'r') as f:
                    content = f.read()
                if len(content) > 5000:
                    content = content[:5000] + "\n\n[...truncated...]"
                response = await self._perplexity.chat(f"Please analyze this:\n\n```\n{content}\n```", wait_for_response=True)
            else:
                await self._perplexity.wait_for_response()
                response = await self._perplexity.get_last_response()

            self._current_conversation['messages'].append({
                'role': 'assistant',
                'content': response,
                'timestamp': datetime.now().isoformat()
            })
            self._current_conversation['updated_at'] = datetime.now().isoformat()

            await self._auto_save()
            return response

        except Exception as e:
            log(f"Error: {e}")
            return f"Error: {str(e)}"

    async def _auto_save(self):
        import json
        if self._current_conversation:
            filepath = os.path.join(self.save_dir, f"{self._current_conversation['id']}.json")
            with open(filepath, 'w') as f:
                json.dump(self._current_conversation, f, indent=2)

    async def load_conversation(self, filepath: str) -> bool:
        import json
        try:
            with open(filepath, 'r') as f:
                self._current_conversation = json.load(f)

            if self._current_conversation.get('url'):
                perplexity = await self._ensure_browser()
                await perplexity.goto(self._current_conversation['url'])
                await asyncio.sleep(3)

            return True
        except Exception as e:
            print(f"Error loading: {e}")
            return False

    async def close(self, keep_browser_open: bool = True):
        if self._perplexity:
            try:
                if keep_browser_open:
                    await self._perplexity.disconnect()
                    log("Disconnected (browser still running)")
                else:
                    await self._perplexity.close_browser()
                    log("Browser closed")
            except Exception as e:
                log(f"Note: {e}")
        self._perplexity = None


class PerplexityCLI:
    def __init__(self, quiet: bool = False):
        self.chat = None
        self.quiet = quiet

    async def login(self):
        print("=" * 70)
        print("PERPLEXITY LOGIN")
        print("=" * 70)
        print("\n1. Connecting to browser...")
        print("2. Navigate to https://www.perplexity.ai")
        print("3. Log in manually")
        print("4. Press Enter here when done\n")

        self.chat = PerplexityManager()

        try:
            await self.chat._ensure_browser()

            print("Browser is open. Please log in now.")
            print("\nPress Enter when you're logged in...")
            input()

            print("\n‚úì Login successful!")
            print(f"‚úì Session saved to: ~/.config/BraveSoftware/Brave-Automation/")

        except Exception as e:
            print(f"\n‚úó Error: {e}")
        finally:
            if self.chat:
                await self.chat.close()

    async def chat_message(self, message: str, session_id: str = None, output_file: str = None):
        import json

        persona_name, actual_message = parse_persona(message)
        persona_content = ""

        if persona_name:
            persona_content = load_persona(persona_name, PERSONAS_DIR)
            if persona_content:
                console.print(f"[dim][Persona: {persona_name}][/dim]\n")
            else:
                console.print(f"[yellow][Warning: Persona '{persona_name}' not found][/yellow]\n")

        self.chat = PerplexityManager()

        try:
            if session_id:
                conv_file = SAVE_DIR / f"{session_id}.json"
                if conv_file.exists():
                    await self.chat.load_conversation(str(conv_file))
                else:
                    console.print(f"[red]Session not found: {session_id}[/red]")
                    self.chat.start_conversation()
            else:
                self.chat.start_conversation()

            full_message = actual_message
            if persona_content:
                full_message = f"{persona_content}\n\n{actual_message}"

            console.print(f"[bold cyan]You:[/bold cyan] {actual_message}")

            if not self.quiet:
                spinner = Spinner("Thinking")
                spinner.start()

            response = await self.chat.send_formatted(full_message)

            if not self.quiet:
                spinner.stop()

            if output_file:
                with open(output_file, 'w') as f:
                    f.write(response)
                console.print(f"[dim]Response written to: {output_file}[/dim]")
            else:
                console.print()
                console.print("[bold green]Perplexity:[/bold green]")
                console.print(Markdown(response))
                console.print()

            if self.chat._current_conversation.get('url'):
                console.print(f"[dim]URL: {self.chat._current_conversation['url']}[/dim]")
                console.print(f"[dim]Session ID: {self.chat._current_conversation['id']}[/dim]")
                console.print(f"\n[dim]Continue with:[/dim]")
                console.print(f"[dim]  ./perplexity continue {self.chat._current_conversation['id']} \"your next message\"[/dim]")

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")
            import traceback
            traceback.print_exc()
        finally:
            if self.chat:
                await self.chat.close()

    async def chat_file(self, filepath: str, message: str = "", session_id: str = None, output_file: str = None):
        if not os.path.exists(filepath):
            console.print(f"[red]Error: File not found: {filepath}[/red]")
            return

        self.chat = PerplexityManager()

        try:
            if session_id:
                conv_file = SAVE_DIR / f"{session_id}.json"
                if conv_file.exists():
                    await self.chat.load_conversation(str(conv_file))
            else:
                self.chat.start_conversation()

            console.print(f"[dim]Uploading: {filepath}[/dim]")
            if message:
                console.print(f"[dim]Message: {message}[/dim]\n")

            response = await self.chat.send_file(filepath, message)

            if output_file:
                with open(output_file, 'w') as f:
                    f.write(response)
                console.print(f"[dim]Response written to: {output_file}[/dim]")
            else:
                console.print()
                console.print("[bold green]Perplexity:[/bold green]")
                console.print(Markdown(response))
                console.print()

            console.print(f"[dim]Session: {self.chat._current_conversation['id']}[/dim]")

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")
        finally:
            if self.chat:
                await self.chat.close()

    async def list_conversations(self):
        import json

        console.print("[bold]" + "=" * 70 + "[/bold]")
        console.print("[bold]SAVED PERPLEXITY CONVERSATIONS[/bold]")
        console.print("[bold]" + "=" * 70 + "[/bold]\n")

        conversations = []
        for f in SAVE_DIR.glob("*.json"):
            try:
                with open(f) as file:
                    data = json.load(file)
                conversations.append({
                    'id': data.get('id', 'Unknown'),
                    'title': data.get('title', 'Untitled'),
                    'updated': data.get('updated_at', 'Unknown')[:10],
                    'messages': len(data.get('messages', [])),
                    'file': f.name
                })
            except:
                pass

        if not conversations:
            console.print("[dim]No saved conversations found.[/dim]")
            return

        conversations.sort(key=lambda x: x['updated'], reverse=True)

        for i, c in enumerate(conversations[:10], 1):
            console.print(f"[bold]{i}. {c['title']}[/bold]")
            console.print(f"   [dim]ID: {c['id']}[/dim]")
            console.print(f"   [dim]Messages: {c['messages']}[/dim]")
            console.print(f"   [dim]Updated: {c['updated']}[/dim]")
            console.print()

        if len(conversations) > 10:
            console.print(f"[dim]... and {len(conversations) - 10} more[/dim]")

    async def show_history(self, session_id: str = None):
        import json

        console.print("[bold]" + "=" * 70 + "[/bold]")
        console.print("[bold]CONVERSATION HISTORY[/bold]")
        console.print("[bold]" + "=" * 70 + "[/bold]\n")

        if session_id:
            conv_file = SAVE_DIR / f"{session_id}.json"
            if not conv_file.exists():
                console.print(f"[red]Session not found: {session_id}[/red]")
                return

            with open(conv_file) as f:
                data = json.load(f)

            console.print(f"[bold]Title:[/bold] {data.get('title', 'Untitled')}")
            console.print(f"[bold]ID:[/bold] {data.get('id')}")
            console.print(f"[bold]Messages:[/bold] {len(data.get('messages', []))}\n")

            for msg in data.get('messages', []):
                role = "You" if msg['role'] == 'user' else "Perplexity"
                content = msg['content'][:200] + "..." if len(msg['content']) > 200 else msg['content']
                role_style = "cyan" if msg['role'] == 'user' else "green"
                console.print(f"[bold {role_style}]{role}:[/bold {role_style}] {content}\n")
        else:
            conversations = list(SAVE_DIR.glob("*.json"))
            if not conversations:
                console.print("[dim]No conversations found.[/dim]")
                return

            most_recent = max(conversations, key=lambda p: p.stat().st_mtime)

            with open(most_recent) as f:
                data = json.load(f)

            console.print(f"[bold]Most recent:[/bold] {data.get('title', 'Untitled')}")
            console.print(f"[bold]ID:[/bold] {data.get('id')}")
            console.print(f"[bold]Messages:[/bold] {len(data.get('messages', []))}\n")

            for msg in data.get('messages', [])[-5:]:
                role = "You" if msg['role'] == 'user' else "Perplexity"
                content = msg['content'][:150] + "..." if len(msg['content']) > 150 else msg['content']
                role_style = "cyan" if msg['role'] == 'user' else "green"
                console.print(f"[bold {role_style}]{role}:[/bold {role_style}] {content}\n")

    def list_personas(self):
        console.print("[bold]" + "=" * 70 + "[/bold]")
        console.print("[bold]AVAILABLE PERSONAS[/bold]")
        console.print("[bold]" + "=" * 70 + "[/bold]\n")

        personas = list_personas_func(PERSONAS_DIR)

        if not personas:
            console.print("[dim]No personas found in personas/ directory[/dim]")
            console.print(f"\n[dim]Create one: echo 'Your prompt' > {PERSONAS_DIR}/myrole.md[/dim]")
            return

        for p in personas:
            console.print(f"[bold yellow]/{p['name']}[/bold yellow]")
            console.print(f"   [dim]{p['preview']}[/dim]\n")

        console.print("[dim]Usage: perplexity chat /analyst \"your question\"[/dim]")

    async def interactive(self, session_id: str = None):
        import json
        import time as time_module

        console.print("[bold cyan]Perplexity Interactive Mode[/bold cyan]")
        console.print("[dim]Commands: /exit /new /save /load <id> /voice /help[/dim]")
        console.print("[dim]Press Enter twice to send message[/dim]\n")

        self.chat = PerplexityManager()
        voice = VoiceRecorder()

        try:
            if session_id:
                conv_file = SAVE_DIR / f"{session_id}.json"
                if conv_file.exists():
                    await self.chat.load_conversation(str(conv_file))
                    console.print(f"[dim]Loaded: {session_id}[/dim]\n")
                else:
                    console.print(f"[red]Session not found: {session_id}[/red]")
                    self.chat.start_conversation()
            else:
                self.chat.start_conversation()

            await self.chat._ensure_browser()

            session = PromptSession(history=FileHistory(str(HISTORY_FILE)))
            buffer = []

            while True:
                try:
                    if buffer:
                        prompt_text = "... "
                    else:
                        prompt_text = "You: "

                    line = await session.prompt_async(prompt_text, mouse_support=False)

                    if line.strip() == "/exit":
                        console.print("[dim]Goodbye![/dim]")
                        break

                    elif line.strip() == "/new":
                        await self.chat._perplexity.start_new_chat()
                        buffer = []
                        console.print("[dim]Started new conversation[/dim]\n")
                        continue

                    elif line.strip() == "/save":
                        await self.chat._auto_save()
                        console.print(f"[dim]Saved: {self.chat._current_conversation['id']}[/dim]\n")
                        continue

                    elif line.strip().startswith("/load "):
                        load_id = line.strip().split(None, 1)[1]
                        conv_file = SAVE_DIR / f"{load_id}.json"
                        if conv_file.exists():
                            await self.chat.load_conversation(str(conv_file))
                            buffer = []
                            console.print(f"[dim]Loaded: {load_id}[/dim]\n")
                        else:
                            console.print(f"[red]Not found: {load_id}[/red]\n")
                        continue

                    elif line.strip() == "/voice":
                        console.print("Recording... Press Enter to stop")
                        if voice.start_recording():
                            await session.prompt_async("Recording... ")
                            transcript, transcribe_time = voice.stop_recording()
                            if transcript:
                                time_str = f"{transcribe_time:.1f}s" if transcribe_time > 0 else ""
                                console.print(f"[dim]Transcribed{time_str}: {transcript}[/dim]")
                                buffer.append(transcript)
                            else:
                                console.print("[red]No speech detected[/red]")
                        else:
                            console.print("[red]Failed to start recording[/red]")
                        continue

                    elif line.strip() == "/help":
                        console.print("""
[dim]Commands:
  /exit        Exit interactive mode
  /new         Start new conversation
  /save        Save current conversation
  /load <id>   Load a conversation
  /voice       Record voice message
  /help        Show this help

Tips:
  - Press Enter twice to send
  - Use /persona_name to apply a persona
  - Arrow keys for history
[/dim]
""")
                        continue

                    elif line.strip() == "" and buffer:
                        message = "\n".join(buffer)
                        buffer = []

                        persona_name, actual_message = parse_persona(message)
                        persona_content = ""

                        if persona_name:
                            persona_content = load_persona(persona_name, PERSONAS_DIR)
                            if not persona_content:
                                console.print(f"[yellow]Persona '{persona_name}' not found[/yellow]\n")

                        full_message = actual_message
                        if persona_content:
                            full_message = f"{persona_content}\n\n{actual_message}"

                        console.print("[dim]Sending...[/dim]")
                        response = await self.chat.send_formatted(full_message)

                        if not response or response.startswith("Error"):
                            console.print(f"[red]Failed to get response: {response}[/red]")
                            continue

                        console.print()
                        console.print("[bold green]Perplexity:[/bold green]")
                        console.print(Markdown(response))
                        console.print()

                        await self.chat._auto_save()
                        continue

                    elif line.strip() == "":
                        continue

                    else:
                        buffer.append(line)

                except KeyboardInterrupt:
                    if voice.recording_process:
                        voice.cancel_recording()
                        console.print("\n[dim]Recording cancelled[/dim]")
                    else:
                        console.print("\n[dim]Press /exit to quit[/dim]")
                    continue
                except EOFError:
                    break

            await self.chat._auto_save()

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")
            import traceback
            traceback.print_exc()
        finally:
            if self.chat:
                await self.chat.close()

    async def library(self, limit: int = 20):
        """List conversations from perplexity.ai/library"""
        from rich.table import Table

        console.print("[bold]" + "=" * 70 + "[/bold]")
        console.print("[bold]PERPLEXITY LIBRARY[/bold]")
        console.print("[bold]" + "=" * 70 + "[/bold]\n")
        console.print("[dim]Navigating to perplexity.ai/library...[/dim]\n")

        manager = PerplexityManager()
        conv_manager = PerplexityConversations(manager.config)

        try:
            conversations = await conv_manager.list_conversations(limit=limit)

            if not conversations:
                console.print("[yellow]No conversations found in library.[/yellow]")
                console.print("[dim]Make sure you're logged in and have conversations.[/dim]")
                return

            table = Table(show_header=True, header_style="bold magenta")
            table.add_column("#", width=4, justify="right")
            table.add_column("Title", width=40)
            table.add_column("Type", width=10)
            table.add_column("ID", width=25)
            table.add_column("Preview", width=30)

            for i, conv in enumerate(conversations, 1):
                preview = conv.preview[:40] + "..." if len(conv.preview) > 40 else conv.preview
                type_icon = "[üîç]" if conv.type.value == "search" else "[üí¨]"
                table.add_row(
                    str(i),
                    conv.title[:40] + "..." if len(conv.title) > 40 else conv.title,
                    type_icon,
                    conv.id,
                    preview
                )

            console.print(table)
            console.print(f"\n[dim]Found {len(conversations)} conversations[/dim]")
            console.print("\n[cyan]Commands:[/cyan]")
            console.print("  ./perplexity library               # List conversations (default)")
            console.print("  ./perplexity library --limit 50    # Increase limit")
            console.print("  ./perplexity open <id>             # Open a conversation")
            console.print("  ./perplexity delete <id>           # Delete a conversation")
            console.print("  ./perplexity spaces                # List spaces")

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")
            import traceback
            traceback.print_exc()
        finally:
            try:
                await conv_manager.close()
                await manager.close(keep_browser_open=True)
            except Exception:
                pass

    async def spaces(self, limit: int = 20):
        """List spaces from perplexity.ai/spaces"""
        from rich.table import Table

        console.print("[bold]" + "=" * 70 + "[/bold]")
        console.print("[bold]PERPLEXITY SPACES[/bold]")
        console.print("[bold]" + "=" * 70 + "[/bold]\n")
        console.print("[dim]Navigating to perplexity.ai/spaces...[/dim]\n")

        try:
            manager = PerplexityManager()
            conv_manager = PerplexityConversations(manager.config)

            spaces = await conv_manager.list_spaces(limit=limit)

            if not spaces:
                console.print("[yellow]No spaces found.[/yellow]")
                console.print("[dim]Create spaces at perplexity.ai/spaces to organize conversations.[/dim]")
                return

            table = Table(show_header=True, header_style="bold magenta")
            table.add_column("#", width=4, justify="right")
            table.add_column("Name", width=40)
            table.add_column("Conversations", width=15, justify="right")
            table.add_column("ID", width=25)
            table.add_column("Description", width=35)

            for i, space in enumerate(spaces, 1):
                desc = (space.description[:32] + "..." if space.description and len(space.description) > 32 else space.description) if space.description else "-"
                table.add_row(
                    str(i),
                    space.name[:40],
                    str(space.conversation_count),
                    space.id,
                    desc
                )

            console.print(table)
            console.print(f"\n[dim]Found {len(spaces)} spaces[/dim]")
            console.print("\n[cyan]Commands:[/cyan]")
            console.print("  ./perplexity spaces                    # List spaces (default)")
            console.print("  ./perplexity spaces --limit 50        # Increase limit")
            console.print("  ./perplexity space-open <id>          # Open a space")
            console.print("  ./perplexity move <conv_id> <space_id> # Move conversation to space")

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")
            import traceback
            traceback.print_exc()
        finally:
            try:
                await conv_manager.close()
                await manager.close(keep_browser_open=True)
            except Exception:
                pass

    async def delete_conversations(self, conversation_ids: List[str], interactive: bool = True):
        """Delete conversations"""
        if not conversation_ids:
            console.print("[red]Error: No conversation IDs provided[/red]")
            console.print("Usage: ./perplexity delete <id1> [id2] [id3]...")
            return

        if interactive:
            console.print("[bold]" + "=" * 70 + "[/bold]")
            console.print("[bold]DELETE CONVERSATIONS[/bold]")
            console.print("[bold]" + "=" * 70 + "[/bold]\n")
            console.print("[yellow]The following conversations will be DELETED:[/yellow]\n")
            for conv_id in conversation_ids:
                console.print(f"  - {conv_id}")
            console.print("\n[red]This action cannot be undone![/red]")
            confirm = input("\nProceed? (y/N): ")
            if confirm.lower() != "y":
                console.print("[dim]Cancelled.[/dim]")
                return

        try:
            manager = PerplexityManager()
            conv_manager = PerplexityConversations(manager.config)

            try:
                console.print("\n[bold]Deletion Results:[/bold]")
                for conv_id in conversation_ids:
                    success = await conv_manager.delete_conversation_via_api(conv_id)
                    if success:
                        console.print(f"  [green]‚úì[/green] {conv_id}")
                    else:
                        console.print(f"  [red]‚úó[/red] {conv_id}")
            finally:
                await conv_manager.close()
                await manager.close(keep_browser_open=True)

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")
            import traceback
            traceback.print_exc()

    async def move_conversations(self, conversation_ids: List[str], space_id: str):
        """Move conversations to a space"""
        if not conversation_ids:
            console.print("[red]Error: No conversation IDs provided[/red]")
            console.print("Usage: ./perplexity move <conv_id> [conv_id...] <space_id>")
            return

        if not space_id:
            console.print("[red]Error: No space ID provided[/red]")
            console.print("Usage: ./perplexity move <conv_id> [conv_id...] <space_id>")
            return

        console.print("[bold]" + "=" * 70 + "[/bold]")
        console.print("[bold]MOVE CONVERSATIONS[/bold]")
        console.print("[bold]" + "=" * 70 + "[/bold]\n")
        console.print("Moving to space:")
        console.print(f"  [cyan]{space_id}[/cyan]\n")
        console.print("Conversations to move:")
        for conv_id in conversation_ids:
            console.print(f"  - {conv_id}")

        try:
            manager = PerplexityManager()
            conv_manager = PerplexityConversations(manager.config)

            try:
                spaces = await conv_manager.list_spaces(limit=100)
                space_names = {s.id: s.name for s in spaces}

                if space_id in space_names:
                    console.print(f"\n[dim]Target: {space_names[space_id]}[/dim]")

                results = await conv_manager.move_to_space(conversation_ids, space_id)

                console.print("\n[bold]Move Results:[/bold]")
                for conv_id, success in results.items():
                    if success:
                        console.print(f"  [green]‚úì[/green] {conv_id} ‚Üí {space_id}")
                    else:
                        console.print(f"  [red]‚úó[/red] {conv_id} ‚Üí {space_id}")
            finally:
                await conv_manager.close()
                await manager.close(keep_browser_open=True)

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")
            import traceback
            traceback.print_exc()

    async def open_conversation(self, conversation_id: str):
        """Open a conversation in browser"""
        if not conversation_id:
            console.print("[red]Error: No conversation ID provided[/red]")
            return

        try:
            manager = PerplexityManager()
            conv_manager = PerplexityConversations(manager.config)

            try:
                success = await conv_manager.open_conversation(conversation_id)

                if success:
                    console.print(f"[green]Opened conversation:[/green] {conversation_id}")
                    console.print(f"[dim]URL: https://www.perplexity.ai/chat/{conversation_id}[/dim]")
                else:
                    console.print(f"[red]Failed to open conversation: {conversation_id}[/red]")
            finally:
                await conv_manager.close()
                await manager.close(keep_browser_open=True)

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")

    async def open_space(self, space_id: str):
        """Open a space in browser"""
        if not space_id:
            console.print("[red]Error: No space ID provided[/red]")
            return

        try:
            manager = PerplexityManager()
            conv_manager = PerplexityConversations(manager.config)

            try:
                success = await conv_manager.open_space(space_id)

                if success:
                    console.print(f"[green]Opened space:[/green] {space_id}")
                    console.print(f"[dim]URL: https://www.perplexity.ai/space/{space_id}[/dim]")
                else:
                    console.print(f"[red]Failed to open space: {space_id}[/red]")
            finally:
                await conv_manager.close()
                await manager.close(keep_browser_open=True)

        except Exception as e:
            console.print(f"\n[red]Error: {e}[/red]")

    async def interactive_select(self, title: str, items: List, key_attr: str, multi: bool = True):
        """Interactive selector using prompt_toolkit checkbox dialog"""
        from prompt_toolkit.shortcuts import checkboxlist_dialog, radiolist_dialog

        if not items:
            console.print("[yellow]No items to select[/yellow]")
            return []

        # Build dialog values: (key, display_text)
        values = []
        for item in items:
            key = getattr(item, key_attr, '')
            # Try title first (conversations), then name (spaces), then str(item)
            display = getattr(item, "title", None) or getattr(item, "name", None) or str(item)
            if len(display) > 60:
                display = display[:57] + "..."
            values.append((key, display))

        if multi:
            result = await checkboxlist_dialog(
                title=title,
                text="Press SPACE to select, ENTER to confirm:",
                values=values,
            ).run_async()
        else:
            result = await radiolist_dialog(
                title=title,
                text="Select one item:",
                values=values,
            ).run_async()

        if result is None:
            return []

        # Convert selected keys to indices
        if multi:
            selected_keys = result
        else:
            selected_keys = [result] if result else []

        indices = []
        for i, item in enumerate(items):
            key = getattr(item, key_attr, '')
            if key in selected_keys:
                indices.append(i)

        return indices

    async def manage_interactive(self):
        """Interactive conversation manager with selectable list"""
        from rich.panel import Panel

        console.print(Panel.fit(
            "[bold cyan]Perplexity Conversation Manager[/bold cyan]\n"
            "[dim]Manage your conversations and spaces interactively[/dim]",
            title="Party Mode"
        ))
        console.print()

        manager = PerplexityManager()
        conv_manager = PerplexityConversations(manager.config)

        current_conversations = []
        current_spaces = []
        selected_conv_indices = []

        # Pre-load spaces at startup using GUI progress dialog
        from prompt_toolkit.shortcuts import message_dialog
        await message_dialog(
            title="Loading",
            text="Loading spaces..."
        ).run_async()
        current_spaces = await conv_manager.list_spaces(limit=50)

        while True:
            try:
                console.print("\n[bold]Main Menu:[/bold]")
                console.print("  [1] Browse Conversations")
                console.print("  [2] Browse Spaces")
                console.print("  [3] Bulk Actions on Conversations")
                console.print("  [q] Quit")

                choice = console.input("\n[cyan]>[/cyan] ").strip().lower()

                if choice == 'q' or choice == 'quit':
                    break

                elif choice == '1':
                    from prompt_toolkit.shortcuts import message_dialog
                    await message_dialog(
                        title="Loading",
                        text="Loading conversations..."
                    ).run_async()
                    current_conversations = await conv_manager.list_conversations(limit=50)

                    if not current_conversations:
                        console.print("[yellow]No conversations found[/yellow]")
                        continue

                    indices = await self.interactive_select(
                        "Conversations",
                        current_conversations,
                        key_attr="id"
                    )

                    if not indices:
                        console.print("[dim]Cancelled[/dim]")
                        continue

                    console.print("\n[bold]Selected Conversations:[/bold]")
                    for i in indices:
                        conv = current_conversations[i]
                        console.print(f"  - {conv.title[:50]} [{conv.id[:12]}...]")

                    from prompt_toolkit.shortcuts import radiolist_dialog

                    action_result = await radiolist_dialog(
                        title="Action",
                        text="Choose an action:",
                        values=[
                            ("open", "Open in browser"),
                            ("move", "Move to space..."),
                            ("delete", "Delete conversations"),
                            ("back", "Back to menu"),
                        ]
                    ).run_async()

                    if action_result == "open":
                        for i in indices:
                            await conv_manager.open_conversation(current_conversations[i].id)
                            console.print(f"[green]Opened: {current_conversations[i].title[:40]}[/green]")
                    elif action_result == "move":
                        if not current_spaces:
                            from prompt_toolkit.shortcuts import message_dialog
                            await message_dialog(
                                title="No Spaces",
                                text="No spaces available. Create a space in Perplexity first."
                            ).run_async()
                            continue
                        
                        space_indices = await self.interactive_select(
                            "Select Target Space",
                            current_spaces,
                            key_attr="id",
                            multi=False
                        )
                        
                        if space_indices:
                            target_space = current_spaces[space_indices[0]]
                            console.print(f"[yellow]Moving {len(indices)} conversation(s) to {target_space.name}...[/yellow]")
                            for i in indices:
                                success = await conv_manager.move_conversation_to_space_via_api(
                                    current_conversations[i].id,
                                    target_space.id
                                )
                                if success:
                                    console.print(f"[green]‚úì Moved: {current_conversations[i].title[:40]}[/green]")
                                else:
                                    console.print(f"[red]‚úó Failed: {current_conversations[i].title[:40]}[/red]")
                            console.print(f"[dim]Refresh conversations to see updated spaces[/dim]")
                    elif action_result == "delete":
                        console.print("[yellow]Deleting...[/yellow]")
                        for i in indices:
                            success = await conv_manager.delete_conversation_via_api(current_conversations[i].id)
                            if success:
                                console.print(f"[green]‚úì Deleted: {current_conversations[i].title[:40]}[/green]")
                            else:
                                console.print(f"[red]‚úó Failed: {current_conversations[i].title[:40]}[/red]")
                        current_conversations = await conv_manager.list_conversations(limit=50)

                elif choice == '2':
                    from prompt_toolkit.shortcuts import message_dialog
                    await message_dialog(
                        title="Loading",
                        text="Loading spaces..."
                    ).run_async()
                    current_spaces = await conv_manager.list_spaces(limit=50)

                    if not current_spaces:
                        console.print("[yellow]No spaces found[/yellow]")
                        continue

                    indices = await self.interactive_select(
                        "Spaces",
                        current_spaces,
                        key_attr="id"
                    )

                    if not indices:
                        console.print("[dim]Cancelled[/dim]")
                        continue

                    from prompt_toolkit.shortcuts import radiolist_dialog

                    action_result = await radiolist_dialog(
                        title="Action",
                        text="Choose an action:",
                        values=[
                            ("open", "Open in browser"),
                            ("back", "Back to menu"),
                        ]
                    ).run_async()

                    if action_result == "open":
                        for i in indices:
                            await conv_manager.open_space(current_spaces[i].id)
                            console.print(f"[green]Opened: {current_spaces[i].name}[/green]")

                elif choice == '3':
                    if not current_conversations:
                        console.print("[yellow]No conversations loaded. Go to option 1 first.[/yellow]")
                        continue

                    console.print("\n[dim]Select conversations to manage...[/dim]")
                    indices = await self.interactive_select(
                        "Select Conversations",
                        current_conversations,
                        key_attr="id"
                    )

                    if not indices:
                        console.print("[dim]Cancelled[/dim]")
                        continue

                    from prompt_toolkit.shortcuts import radiolist_dialog

                    action_result = await radiolist_dialog(
                        title="Bulk Actions",
                        text="Choose an action:",
                        values=[
                            ("delete", "Delete selected"),
                            ("move", "Move to space..."),
                            ("back", "Back"),
                        ]
                    ).run_async()

                    if action_result == "delete":
                        console.print("[yellow]Deleting...[/yellow]")
                        for i in indices:
                            success = await conv_manager.delete_conversation_via_api(current_conversations[i].id)
                            if success:
                                console.print(f"[green]‚úì Deleted: {current_conversations[i].title[:40]}[/green]")
                            else:
                                console.print(f"[red]‚úó Failed: {current_conversations[i].title[:40]}[/red]")
                        current_conversations = await conv_manager.list_conversations(limit=50)

                    elif action_result == "move":
                        if not current_spaces:
                            current_spaces = await conv_manager.list_spaces(limit=50)

                        space_indices = await self.interactive_select(
                            "Select Target Space",
                            current_spaces,
                            key_attr="id",
                            multi=False
                        )

                        if space_indices:
                            target_space = current_spaces[space_indices[0]]
                            console.print(f"[yellow]Moving {len(indices)} conversation(s) to {target_space.name}...[/yellow]")
                            for i in indices:
                                success = await conv_manager.move_conversation_to_space_via_api(
                                    current_conversations[i].id,
                                    target_space.id
                                )
                                if success:
                                    console.print(f"[green]‚úì Moved: {current_conversations[i].title[:40]}[/green]")
                                else:
                                    console.print(f"[red]‚úó Failed: {current_conversations[i].title[:40]}[/red]")
                            console.print(f"[dim]Refresh conversations to see updated spaces[/dim]")

            except KeyboardInterrupt:
                console.print("\n[dim]Press Q to quit[/dim]")
                continue
            except EOFError:
                break

        await conv_manager.close()
        await manager.close(keep_browser_open=True)
        console.print("\n[dim]Goodbye![/dim]")

    async def interactive_conversation_manager(self):
        """Interactive conversation manager with selection mode"""
        from rich.prompt import Prompt
        from rich.table import Table

        console.print("[bold cyan]Perplexity Conversation Manager[/bold cyan]")
        console.print("[dim]Commands: /library /spaces /open <id> /delete <id> /move <id> <space> /exit /help[/dim]\n")

        manager = PerplexityManager()
        conv_manager = PerplexityConversations(manager.config)
        selection_mode = False
        selected_ids = []
        current_spaces = []
        current_conversations = []

        while True:
            try:
                prompt_text = "[cyan]>[/cyan] "
                user_input = Prompt.ask(prompt_text, default="")

                if user_input.strip() == "/exit" or user_input.strip() == "":
                    if selection_mode:
                        selection_mode = False
                        selected_ids = []
                        console.print("[dim]Selection cleared.[/dim]")
                        continue
                    console.print("[dim]Goodbye![/dim]")
                    break

                elif user_input.strip() == "/library":
                    console.print("\n[dim]Loading conversations from library...[/dim]\n")
                    current_conversations = await conv_manager.list_conversations(limit=30)
                    current_spaces = []

                    if not current_conversations:
                        console.print("[yellow]No conversations found in library.[/yellow]\n")
                    else:
                        table = Table(show_header=True, header_style="bold magenta")
                        table.add_column("#", width=4, justify="right")
                        table.add_column("Title", width=40)
                        table.add_column("Type", width=10)
                        table.add_column("ID", width=25)
                        for i, conv in enumerate(current_conversations[:20], 1):
                            type_icon = "üîç" if conv.type.value == "search" else "üí¨"
                            table.add_row(str(i), conv.title[:38], type_icon, conv.id)
                        console.print(table)
                        console.print(f"\n[dim]Found {len(current_conversations)} conversations[/dim]")
                        console.print("[dim]Use /open <id> to open a conversation[/dim]\n")
                    selection_mode = False
                    selected_ids = []

                elif user_input.strip() == "/spaces":
                    console.print("\n[dim]Loading spaces...[/dim]\n")
                    current_spaces = await conv_manager.list_spaces(limit=20)
                    current_conversations = []

                    if not current_spaces:
                        console.print("[yellow]No spaces found.[/yellow]\n")
                    else:
                        table = Table(show_header=True, header_style="bold magenta")
                        table.add_column("#", width=4, justify="right")
                        table.add_column("Name", width=40)
                        table.add_column("Conversations", width=12, justify="right")
                        table.add_column("ID", width=25)
                        for i, space in enumerate(current_spaces, 1):
                            table.add_row(str(i), space.name[:38], str(space.conversation_count), space.id)
                        console.print(table)
                        console.print(f"\n[dim]Found {len(current_spaces)} spaces[/dim]\n")
                    selection_mode = False
                    selected_ids = []

                elif user_input.strip() == "/help":
                    console.print("""
[bold]Conversation Manager Commands:[/bold]
  /library               Load conversations from library
  /spaces                List all spaces
  /open <id>             Open a conversation in browser
  /delete <id> [id...]   Delete conversation(s)
  /move <id> <space_id>  Move conversation to space
  /exit                  Exit (clears selection if active)

[bold]Tips:[/bold]
  - Run /library to see your conversations with IDs
  - Copy the ID from the table to use with /open /delete /move
                    """)

                elif user_input.strip().startswith("/open "):
                    parts = user_input.strip().split(None, 1)
                    if len(parts) > 1:
                        conv_id = parts[1].strip()
                        success = await conv_manager.open_conversation(conv_id)
                        if success:
                            console.print(f"[green]Opened: {conv_id}[/green]")
                        else:
                            console.print(f"[red]Failed to open: {conv_id}[/red]")

                elif user_input.strip().startswith("/delete "):
                    parts = user_input.strip().split(None, 1)
                    if len(parts) > 1:
                        ids_to_delete = parts[1].strip().split()
                        for conv_id in ids_to_delete:
                            success = await conv_manager.delete_conversation_via_api(conv_id)
                            if success:
                                console.print(f"[green]‚úì Deleted: {conv_id}[/green]")
                            else:
                                console.print(f"[red]‚úó Failed: {conv_id}[/red]")
                        current_conversations = []

                elif user_input.strip().startswith("/move "):
                    parts = user_input.strip().split(None, 2)
                    if len(parts) > 2:
                        conv_ids = parts[1].strip().split()
                        space_id = parts[2].strip()
                        for conv_id in conv_ids:
                            results = await conv_manager.move_to_space([conv_id], space_id)
                            if results.get(conv_id):
                                console.print(f"[green]‚úì Moved: {conv_id} ‚Üí {space_id}[/green]")
                            else:
                                console.print(f"[red]‚úó Failed: {conv_id}[/red]")
                        current_conversations = []

                else:
                    console.print(f"[yellow]Unknown command: {user_input}[/yellow]")
                    console.print("[dim]Type /help for available commands[/dim]")

            except KeyboardInterrupt:
                console.print("\n[dim]Press /exit to quit[/dim]")
                continue
            except EOFError:
                break

        await conv_manager.close()
        await manager.close(keep_browser_open=True)


def main():
    parser = argparse.ArgumentParser(
        description='Perplexity CLI - Command line interface for Perplexity',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  perplexity login                              # Login to Perplexity
  perplexity interactive                        # Interactive REPL mode
  perplexity chat "Explain quantum computing"   # Send a message
  perplexity chat /analyst "Review this plan"   # Use persona
  perplexity chat --file document.pdf           # Upload a file
  perplexity personas                           # List available personas
  perplexity list                               # List conversations
  perplexity history                            # Show recent history
  perplexity continue perp_2024_02_10           # Continue a conversation
  perplexity manage                             # Interactive UI with arrow keys & bulk select
  perplexity library                            # List conversations from library
  perplexity spaces                             # List spaces
  perplexity delete <id>                       # Delete conversation
  perplexity move <id> <space_id>              # Move to space

Flags:
  -v, --verbose    Show debug output (connection status, etc.)
  -q, --quiet      Disable spinner animation
        """
    )

    parser.add_argument('-v', '--verbose', action='store_true', help='Show debug output')
    parser.add_argument('-q', '--quiet', action='store_true', help='Disable spinner animation')

    subparsers = parser.add_subparsers(dest='command', help='Command to run')

    # Login
    login_parser = subparsers.add_parser('login', help='Login to Perplexity')

    # Chat
    chat_parser = subparsers.add_parser('chat', help='Send a message')
    chat_parser.add_argument('message', nargs='?', help='Message to send')
    chat_parser.add_argument('--file', '-f', help='File to upload')
    chat_parser.add_argument('--prompt-file', '-p', help='Read prompt from file')
    chat_parser.add_argument('--session', '-s', help='Session ID to continue')
    chat_parser.add_argument('--output', '-o', help='Write response to file (markdown format)')

    # List
    list_parser = subparsers.add_parser('list', help='List saved conversations')

    # Personas
    personas_parser = subparsers.add_parser('personas', help='List available personas')

    # History
    history_parser = subparsers.add_parser('history', help='Show conversation history')
    history_parser.add_argument('--session', '-s', help='Session ID to show')

    # Interactive
    interactive_parser = subparsers.add_parser('interactive', help='Interactive REPL mode')
    interactive_parser.add_argument('--session', '-s', help='Session ID to continue')

    # Continue
    continue_parser = subparsers.add_parser('continue', help='Continue a conversation')
    continue_parser.add_argument('session_id', help='Session ID to continue')
    continue_parser.add_argument('message', nargs='?', help='Message to send')
    continue_parser.add_argument('--output', '-o', help='Write response to file (markdown format)')

    # Library
    library_parser = subparsers.add_parser('library', help='List conversations from perplexity.ai/library')
    library_parser.add_argument('--limit', '-l', type=int, default=20, help='Maximum number of conversations to list')

    # Spaces
    spaces_parser = subparsers.add_parser('spaces', help='List spaces from perplexity.ai/spaces')
    spaces_parser.add_argument('--limit', '-l', type=int, default=20, help='Maximum number of spaces to list')

    # Delete
    delete_parser = subparsers.add_parser('delete', help='Delete conversations')
    delete_parser.add_argument('conversation_ids', nargs='+', help='Conversation ID(s) to delete')
    delete_parser.add_argument('--yes', '-y', action='store_true', help='Skip confirmation')

    # Move
    move_parser = subparsers.add_parser('move', help='Move conversations to a space')
    move_parser.add_argument('conversation_ids', nargs='+', help='Conversation ID(s) to move')
    move_parser.add_argument('space_id', help='Target space ID')

    # Open conversation
    open_parser = subparsers.add_parser('open', help='Open a conversation in browser')
    open_parser.add_argument('conversation_id', help='Conversation ID to open')

    # Open space
    space_open_parser = subparsers.add_parser('space-open', help='Open a space in browser')
    space_open_parser.add_argument('space_id', help='Space ID to open')

    # Interactive conversation manager with keyboard navigation
    manager_parser = subparsers.add_parser('manage', help='Interactive UI with arrow keys, space to select, bulk actions')

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return

    set_verbose(args.verbose)
    cli = PerplexityCLI(quiet=args.quiet)

    if args.command == 'login':
        asyncio.run(cli.login())
    elif args.command == 'chat':
        output_file = getattr(args, 'output', None)
        if args.file:
            asyncio.run(cli.chat_file(args.file, args.message or "", args.session, output_file))
        elif args.prompt_file:
            with open(args.prompt_file, 'r') as f:
                prompt = f.read().strip()
            asyncio.run(cli.chat_message(prompt, args.session, output_file))
        elif args.message:
            asyncio.run(cli.chat_message(args.message, args.session, output_file))
        else:
            print("Error: Provide a message, --prompt-file, or --file")
    elif args.command == 'list':
        asyncio.run(cli.list_conversations())
    elif args.command == 'personas':
        cli.list_personas()
    elif args.command == 'history':
        asyncio.run(cli.show_history(args.session))
    elif args.command == 'interactive':
        asyncio.run(cli.interactive(args.session))
    elif args.command == 'continue':
        output_file = getattr(args, 'output', None)
        if args.message:
            asyncio.run(cli.chat_message(args.message, args.session_id, output_file))
        else:
            print("Error: Provide a message to continue")
    elif args.command == 'library':
        asyncio.run(cli.library(limit=args.limit))
    elif args.command == 'spaces':
        asyncio.run(cli.spaces(limit=args.limit))
    elif args.command == 'delete':
        asyncio.run(cli.delete_conversations(args.conversation_ids, interactive=not args.yes))
    elif args.command == 'move':
        conv_ids = args.conversation_ids[:-1]
        space_id = args.conversation_ids[-1]
        asyncio.run(cli.move_conversations(conv_ids, space_id))
    elif args.command == 'open':
        asyncio.run(cli.open_conversation(args.conversation_id))
    elif args.command == 'space-open':
        asyncio.run(cli.open_space(args.space_id))
    elif args.command == 'manage':
        asyncio.run(cli.manage_interactive())


if __name__ == '__main__':
    main()
